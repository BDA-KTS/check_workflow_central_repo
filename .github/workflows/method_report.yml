name: Runs on Jupyter4NFDI
permissions:
  contents: write


on:
  repository_dispatch:
    types: [ method ]


jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout central repository
        uses: actions/checkout@v6
        with:
          path: 'central'

      - name: Checkout repository to test
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          repository: '${{ github.event.client_payload.repository_full_name }}'
          ref: ${{ github.event.client_payload.repo_hash }}
          path: 'testee'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r central/requirements.txt

      - name: Generate Report
        run: python central/method_report_creator.py
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}

      - name: Test on Jupyter4NFDI
        uses: NFDI-Jupyter/ghactions/.github/actions/notebooks@main
        with:
          repo: ${{ github.event.client_payload.repository_full_name }}
          ref: ${{ github.event.client_payload.repo_hash }}
          token: ${{ secrets.JUPYTERHUB_API_TOKEN }}
          notebook_dirs: "src"
        env:
          PYTHONPATH: ${{ github.workspace }}/testee



  - name: Commit and Push the Report
    working-directory: central
    run: |
      git config user.name "github-actions[bot]"
      git config user.email "github-actions[bot]@users.noreply.github.com"
      
      # Use the environment variable or payload directly for the path
      REPORT_PATH="report/${{ github.event.client_payload.repository_full_name }}.md"
      
      if [ -f "$REPORT_PATH" ]; then
        git add "$REPORT_PATH"
        git commit -m "Add report for ${{ github.event.client_payload.repository_full_name }}" || echo "No changes to commit"
        git push
      else
        echo "Report file not found: $REPORT_PATH"
        exit 1
      fi

