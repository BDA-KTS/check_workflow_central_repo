name: Runs on Jupyter4NFDI
permissions:
  contents: write


on:
  repository_dispatch:
    types: [method]


jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout central repository
        uses: actions/checkout@v6
        with:
          path: 'central'

      - name: Checkout repository to test
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          repository: '${{ github.event.client_payload.repository_full_name }}'
          ref: ${{ github.event.client_payload.repo_hash }}
          path: 'testee'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r central/requirements.txt

      - name: Generate Report
        run: python central/method_report_creator.py
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}

      - name: Run Jupyter notebooks and capture logs
        id: run_jupyter
        run: |
          OWNER="${{ github.event.client_payload.repository_owner }}"
          REPO="${{ github.event.client_payload.repository_name }}"
          REPORT_DIR="central/report/$OWNER"
          REPORT_FILE="$REPORT_DIR/$REPO.md"
          LOG_FILE="$REPORT_DIR/${REPO}_papermill.log"

          mkdir -p "$REPORT_DIR"

          set -o pipefail

          echo "Running Jupyter4NFDI notebooks..."

          # Run the composite action script directly and capture logs
          python /home/runner/work/_actions/NFDI-Jupyter/ghactions/main/.github/actions/notebooks/run_papermill.py \
            --repo "${{ github.event.client_payload.repository_full_name }}" \
            --ref "${{ github.event.client_payload.repo_hash }}" \
            --api-url "https://hub.nfdi-jupyter.de/hub/api/job" \
            --token "${{ secrets.JUPYTERHUB_API_TOKEN }}" \
            --notebook-dirs "src" \
            --user-options '{"pre_install":"for f in $(ls /home/jovyan/src); do case \"$f\" in requirements*.txt) pip install -r /home/jovyan/src/$f ;; environment*.yml) conda env update -f /home/jovyan/src/$f ;; *.R) Rscript /home/jovyan/src/$f ;; esac; done","env":{"PYTHONPATH":"/home/jovyan/src"}}' \
            2>&1 | tee "$LOG_FILE"

          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0

      - name: Append Papermill logs to report
        run: |
          OWNER="${{ github.event.client_payload.repository_owner }}"
          REPO="${{ github.event.client_payload.repository_name }}"
          REPORT_FILE="central/report/$OWNER/$REPO.md"
          LOG_FILE="central/report/$OWNER/${REPO}_papermill.log"

          echo "" >> "$REPORT_FILE"
          echo "## Papermill Logs" >> "$REPORT_FILE"
          echo '```' >> "$REPORT_FILE"
          cat "$LOG_FILE" >> "$REPORT_FILE"
          echo '```' >> "$REPORT_FILE"

      - name: Fail workflow if Papermill failed
        if: steps.run_jupyter.outputs.exit_code != '0'
        run: |
          echo "Papermill execution failed."
          exit 1
      
      
      
      

      - name: Commit and Push the Report
        working-directory: central
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Use the environment variable or payload directly for the path
          REPORT_PATH="report/${{ github.event.client_payload.repository_full_name }}.md"
          
          if [ -f "$REPORT_PATH" ]; then
            git add "$REPORT_PATH"
            git commit -m "Add report for ${{ github.event.client_payload.repository_full_name }}" || echo "No changes to commit"
            git push
          else
            echo "Report file not found: $REPORT_PATH"
            exit 1
          fi

